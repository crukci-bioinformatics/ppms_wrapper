<% content_for :header_tags do %>
<%= stylesheet_link_tag 'ppms.css', :plugin => 'ppms', :media => 'all' %>
<% end %>

<h3>Time Orders Awaiting Notification</h3>

<% if @issues_by_group.empty? %>
    <p>
        There are no outstanding orders to mail.
    </p>
<% else %>
    <%= form_tag '/ppms/order_mailer' do %>
        <p>
            <%= submit_tag "Click to send these summaries to group leaders" %>
        </p> 
    <% end %>
    
    <% @issues_by_group.each do |group_id, group_struct| %>
        <% ppms_group = group_struct.group %>
        <% issue_ids = group_struct.issues.keys.sort.reverse %>
    
        <h4><%= ppms_group['unitname'] %></h4>
    
        <table class="ppms_report" style="width: 100%">
            <thead>
                <tr>
                    <th>Issue</th>
                    <th>Experiment Type</th>
                    <th>Researcher</th>
                    <th>PPMS Order</th>
                    <th>Time</th>
                    <th>Cost</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                <% issue_ids.each do |issue_id| %>
                    <% issue = group_struct.issues[issue_id] %>
                    <% experiment_type = issue.custom_values.select { |cv| cv.custom_field_id == @experiment_type_field.id }.first&.value %>
                    <% researcher = issue.custom_values.select { |cv| cv.custom_field_id == @researcher_field.id }.first&.value %>
    
                    <% group_struct.orders_by_issue[issue.id].each do |order_id, ppms_order| %>
                        <% time_orders = group_struct.time_entries[issue.id].select { |teo| teo.order_id == order_id } %>
                        <% total_time = time_orders.inject(0.0) { |sum, teo| sum + teo.time_entry.hours } %>
                        <tr>
                            <td><abbr title="<%= issue.subject %>"><a href="/issues/<%= issue.id %>"><%= issue.id %></a></abbr></td>
                            <td><%= experiment_type %></td>
                            <td><abbr title="<%= issue.project.name %>"><%= researcher %></abbr></td>
                            <td><%= order_id %></td>
                            <td><%= hours_minutes(total_time) %></td>
                            <td>&pound;<%= '%.2f' % ppms_order['Cost'].to_f %></td>
                            <td>
                                <% time_orders.each do |entry| %>
                                    <%= '%.2f' % entry.time_entry.hours %> <%= entry.time_entry.user %><br />
                                <% end %>
                            </td>
                        </tr>
                    <% end %>
                <% end %>
            </tbody>
        </table>
    <% end %>
    
    
    <table class="ppms_report">
        <thead>
            <tr>
                <th>Order id</th>
                <th>Logged By</th>
                <th>Issue</th>
                <th>Time</th>
                <th>Activity</th>
                <th>Price</th>
            </tr>
        </thead>
        <tbody>
            <% @issues_by_group.values.each do |group_struct| %>
                <% orders = group_struct.orders %>
                <% group_struct.time_entries.values.flatten.each do |time_order| %>
                    <tr>
                        <td><%= time_order.order_id %></td>
                        <td><%= time_order.time_entry.user %></td>
                        <td><abbr title="<%= time_order.issue.subject %>"><a href="/issues/<%= time_order.issue.id %>"><%= time_order.issue.id %></a></abbr></td>
                        <td><%= hours_minutes(time_order.time_entry.hours) %></td>
                        <td><%= time_order.time_entry.activity %></td>
                        <td>&pound;<%= '%.2f' % (orders[time_order.order_id]['Rate'] * time_order.time_entry.hours)%></td>
                    </tr>
                <% end %>
            <% end %>
        </tbody>
    </table>
<% end %>
